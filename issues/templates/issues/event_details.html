{% extends "issues/base.html" %}
{% load static %}
{% load stricter_templates %}
{% load humanize %}

{% block tab_content %}

<div class="flex">
    <div class="overflow-hidden">
        <div class="italic text-ellipsis whitespace-nowrap overflow-hidden">{{ event.ingested_at|date:"j M G:i T" }} (Event {{ event.digest_order|intcomma }} of {{ issue.digested_event_count|intcomma }} total{% if q %} — {{ event_qs_count|intcomma }} found by search{% endif %})</div>
    </div>

    <div class="ml-auto flex-none">
        <div class="flex place-content-end">
            {% include "issues/_event_nav.html" %}
        </div>
    </div>
</div>

<h1 id="key-info" class="text-2xl font-bold mt-4">Key info</h1>

<div class="mb-6">
    {% for key, value in key_info %}
        <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
            <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
            <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
        </div>
    {% endfor %}
</div>

{# --- Ask Gemini 按鈕區塊 (開始) --- #}
<div class="flex flex-col items-end mb-6">
    {# 1. 按鈕: 保持原本的樣式 #}
    <a href="javascript:void(0)"
       id="ask-gemini-btn"
       data-api-url="{% url 'trigger_useapi' issue.pk event.id %}"
       class="flex items-center px-4 py-2 text-sm font-bold text-white bg-cyan-600 hover:bg-cyan-700 rounded shadow-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-2">
            <path fill-rule="evenodd" d="M9 4.5a.75.75 0 01.721.544l.813 2.846a3.75 3.75 0 002.576 2.576l2.846.813a.75.75 0 010 1.442l-2.846.813a3.75 3.75 0 00-2.576 2.576l-.813 2.846a.75.75 0 01-1.442 0l-.813-2.846a3.75 3.75 0 00-2.576-2.576l-2.846-.813a.75.75 0 010-1.442l2.846-.813a3.75 3.75 0 002.576-2.576l.813-2.846A.75.75 0 019 4.5zM9 15a.75.75 0 01.75.75v1.5h1.5a.75.75 0 010 1.5h-1.5v1.5a.75.75 0 01-1.5 0v-1.5h-1.5a.75.75 0 010-1.5h1.5v-1.5A.75.75 0 019 15z" clip-rule="evenodd" />
        </svg>
        Ask Gemini
    </a>

    {# 2. 結果顯示區塊 (預設隱藏) #}
    {# [修改重點] 加入 'prose' 類別：這是 Tailwind 的排版外掛，專門用來讓 Markdown 轉出來的 HTML 變漂亮 #}
    <div id="gemini-response-area" class="hidden w-full mt-4 p-6 border-l-4 border-cyan-500 bg-slate-50 dark:bg-slate-800 rounded shadow-sm text-left">
        <h3 class="font-bold text-cyan-700 dark:text-cyan-400 mb-4 flex items-center text-lg">
            Gemini Analysis
            <span id="gemini-loading" class="ml-2 hidden animate-pulse text-gray-500 font-normal text-sm">Thinking...</span>
        </h3>
        {# [修改重點] 移除 whitespace-pre-wrap，因為轉換後的 HTML 會自己處理換行 #}
        {# 加入 prose-sm 或 prose-base 控制字體大小，prose-slate 設定顏色風格 #}
        <div id="gemini-content" class="prose prose-slate dark:prose-invert max-w-none text-sm leading-relaxed"></div>
    </div>
</div>
{# --- Ask Gemini 按鈕區塊 (結束) --- #}

{% if logentry_info %}
    <h1 id="logentry" class="text-2xl font-bold mt-4">Log Entry</h1>
    <div class="mb-6">
        {% for key, value in logentry_info %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if deployment_info %}
    <h1 id="deployment" class="text-2xl font-bold mt-4">Deployment</h1>
    <div class="mb-6">
        {% for key, value in deployment_info %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if event.get_tags %}
    <h1 id="tags" class="text-2xl font-bold mt-4">Tags</h1>
    <div class="mb-6">
        {% for tag in event.get_tags %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ tag.value.key.key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ tag.value.value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if parsed_data.user %}
    <h1 id="user" class="text-2xl font-bold mt-4">User</h1>
    <div class="mb-6">
        {% for key, value in parsed_data.user|items %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if parsed_data.request %}
    <h1 id="request" class="text-2xl font-bold mt-4">Request</h1>
    <div class="mb-6">
        <div>
            {% for key, value in parsed_data.request|items %}
                {% if key != "headers" and key != "env" %}
                    <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                        <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                        <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        {% if parsed_data.request.headers %}
        <h3 class="font-bold mt-2">REQUEST HEADERS</h3>
        <div>
        {% for key, value in parsed_data.request.headers.items %}
        <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %} border-dotted">
            <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
            <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
        </div>
        {% endfor %}
        </div>
        {% endif %}

        {% if parsed_data.request.env %}
        <h3 class="font-bold mt-2">REQUEST ENV</h3>
        <div>
        {% for key, value in parsed_data.request.env.items %}
        <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %} border-dotted">
            <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
            <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
        </div>
        {% endfor %}
        </div>
        {% endif %}
    </div>
{% endif %}

{% if contexts %}
    <h1 id="runtime" class="text-2xl font-bold mt-4">Contexts</h1>
    <div class="mb-6">
        {% for context_key, context in contexts|items %}
            <h3 class="font-bold mt-2">{{ context_key|upper }}</h3>
            {% for key, value in context|items %}
                <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                    <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                    <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
{% endif %}

{% if parsed_data.modules %}
    <h1 id="modules" class="text-2xl font-bold mt-4">Modules</h1>
    <div class="mb-6">
        {% for key, value in parsed_data.modules|sorted_items %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if parsed_data.sdk %}
    <h1 id="sdk" class="text-2xl font-bold mt-4">SDK</h1>
    <div class="mb-6">
        {% for key, value in parsed_data.sdk|items %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if sourcemaps_images %}
    <h1 id="sourcemaps_images" class="text-2xl font-bold mt-4">Sourcemap IDs</h1>
    <div class="mb-6">
        {% for key, value in sourcemaps_images %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{% if parsed_data.extra %}
    <h1 id="extra" class="text-2xl font-bold mt-4">Extra</h1>
    <div class="mb-6">
        {% for key, value in parsed_data.extra|items %}
            <div class="flex {% if forloop.first %}border-slate-300 dark:border-slate-600 border-t-2{% endif %}">
                <div class="w-1/4 {% if not forloop.last %}border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %}">{{ key }}</div>
                <div class="w-3/4 {% if not forloop.last %} border-b-2 border-dotted border-slate-300 dark:border-slate-600{% endif %} font-mono">{{ value|linebreaks }}</div>
            </div>
        {% endfor %}
    </div>
{% endif %}

{# 修改 3: 加入 JavaScript 來處理按鈕點擊 #}
{# [新增] 引入 Marked.js 解析庫 (透過 CDN) #}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

{# 3. JavaScript 邏輯 #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('ask-gemini-btn');
        const responseArea = document.getElementById('gemini-response-area');
        const contentDiv = document.getElementById('gemini-content');
        const loadingSpan = document.getElementById('gemini-loading');
        
        btn.addEventListener('click', function(e) {
            e.preventDefault(); 
            
            // UI 重置
            responseArea.classList.remove('hidden');
            loadingSpan.classList.remove('hidden');
            loadingSpan.classList.add('block');
            contentDiv.innerHTML = ""; // 清空內容
            
            const apiUrl = btn.getAttribute('data-api-url');
            
            fetch(apiUrl)
                .then(async response => {
                    const text = await response.text();
                    let data;
                    try { data = JSON.parse(text); } catch (e) { data = null; }

                    if (!response.ok) {
                        let msg = response.statusText;
                        if (data && data.analysis) msg = data.analysis;
                        else if (text) msg = text.replace(/<[^>]*>/g, '').substring(0, 300);
                        throw new Error(`Server Error (${response.status}): ${msg}`);
                    }
                    return data;
                })
                .then(data => {
                    loadingSpan.classList.add('hidden');
                    
                    // [關鍵修改] 使用 marked.parse 將 Markdown 轉為 HTML
                    // 這會自動處理 **粗體**、*列表* 以及 \n 換行
                    contentDiv.innerHTML = marked.parse(data.analysis);
                })
                .catch(error => {
                    loadingSpan.classList.add('hidden');
                    // 錯誤訊息通常是純文字，我們簡單包裝一下
                    contentDiv.innerHTML = `<div class="text-red-600 font-bold">執行失敗</div><div class="text-red-500">${error.message}</div>`;
                });
        });
    });
</script>

{% endblock %}

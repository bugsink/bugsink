#!/bin/bash

# ==========================================
# 1. è¨­å®šèˆ‡è®Šæ•¸
# ==========================================
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
else
    # Fallback
    SECRET_KEY=${SECRET_KEY:-"dev-key"}
    CREATE_SUPERUSER=${CREATE_SUPERUSER:-"admin:admin"}
    REPORT_HOST=${REPORT_HOST:-"localhost:8000"}
    PORT=${PORT:-8000}
    DOCKER_PORT=${DOCKER_PORT:-8000}
    IMAGE_NAME=${IMAGE_NAME:-"bugsink-v13"}
    CONTAINER_NAME=${CONTAINER_NAME:-"bugsink-v13"}
fi

# ==========================================
# 2. æº–å‚™è³‡æ–™åº«æ›è¼‰é» (è§£æ±º Ghost Database)
# ==========================================
DATA_DIR="$(pwd)/bugsink_data"

echo "ğŸ“‚ [1/6] æº–å‚™è³‡æ–™åº«ç›®éŒ„: $DATA_DIR"
# å»ºç«‹ç›®éŒ„
mkdir -p "$DATA_DIR"
# çµ¦äºˆå¯¬é¬†æ¬Šé™ï¼Œç¢ºä¿å®¹å™¨å…§çš„ bugsink ä½¿ç”¨è€…(uid:1000) å¯ä»¥å¯«å…¥
chmod 777 "$DATA_DIR"

# ==========================================
# 3. å•Ÿå‹•å®¹å™¨
# ==========================================
echo "ğŸ›‘ [2/6] é‡å•Ÿå®¹å™¨..."
sudo docker rm -f $CONTAINER_NAME 2>/dev/null

echo "ğŸš€ [3/6] å•Ÿå‹• Bugsink Docker..."
# æ³¨æ„ï¼š
# 1. -e DATABASE_PATH="/data/db.sqlite3" : å¼·åˆ¶æŒ‡å®šè·¯å¾‘
# 2. -v $DATA_DIR:/data : å°‡æœ¬æ©Ÿç›®éŒ„æ›è¼‰é€²å»
sudo docker run -d \
    --name $CONTAINER_NAME \
    -e SECRET_KEY="$SECRET_KEY" \
    -e CREATE_SUPERUSER="$CREATE_SUPERUSER" \
    -e REPORT_HOST="$REPORT_HOST" \
    -e DATABASE_PATH="/data/db.sqlite3" \
    -e PORT=$PORT \
    -p $DOCKER_PORT:$PORT \
    -v $(pwd)/init_bugsink.py:/app/init_bugsink.py \
    -v "$DATA_DIR":/data \
    $IMAGE_NAME

# ==============================================================
# [æ™ºæ…§ç­‰å¾…] æª¢æŸ¥ Team è¡¨æ ¼æ˜¯å¦å·²ç”±å®¹å™¨è‡ªå‹•å»ºç«‹
# é€™å–ä»£äº†æ‰‹å‹• migrateï¼Œæˆ‘å€‘ç­‰å¾…å®¹å™¨è‡ªå·±å®Œæˆå·¥ä½œ
# ==============================================================
echo "â³ [4/6] ç­‰å¾…å®¹å™¨å…§éƒ¨è‡ªå‹•åˆå§‹åŒ–è³‡æ–™åº«..."

MAX_RETRIES=60 # ç­‰å¾…æœ€å¤š 120 ç§’ (å› ç‚ºåˆæ¬¡å•Ÿå‹•å¯èƒ½è¼ƒæ…¢)
count=0
DB_READY=0

# Python æŒ‡ä»¤ï¼šå˜—è©¦æŸ¥è©¢ teams_team è¡¨æ ¼
CHECK_CMD="python manage.py shell -c \"from django.db import connection; cursor = connection.cursor(); cursor.execute('SELECT 1 FROM teams_team LIMIT 1'); print('READY_TO_GO')\""

while [ $count -lt $MAX_RETRIES ]; do
    # ä½¿ç”¨ 2>/dev/null éš±è— Python çš„éŒ¯èª¤è¼¸å‡º (ä¾‹å¦‚ no such table)
    # æˆ‘å€‘åªé—œå¿ƒæ˜¯å¦å°å‡ºäº† READY_TO_GO
    if sudo docker exec $CONTAINER_NAME sh -c "$CHECK_CMD" 2>/dev/null | grep -q "READY_TO_GO"; then
        echo "âœ… è³‡æ–™åº«å·²å°±ç·’ï¼(Found teams_team table)"
        DB_READY=1
        break
    fi
    
    echo "   ...ç­‰å¾… Migration ä¸­ ($count/$MAX_RETRIES)"
    sleep 2
    count=$((count+1))
done

if [ $DB_READY -eq 0 ]; then
    echo "âŒ éŒ¯èª¤: ç­‰å¾…é€¾æ™‚ï¼Œå®¹å™¨å…§éƒ¨çš„ Migration å¯èƒ½å¤±æ•—æˆ–å¤ªæ…¢ã€‚"
    echo "   å»ºè­°æŸ¥çœ‹æ—¥èªŒ: sudo docker logs $CONTAINER_NAME"
    exit 1
fi

# ==========================================
# 4. åŸ·è¡Œåˆå§‹åŒ–èˆ‡åŒ¯å‡º
# ==========================================

echo "ğŸ”§ [5/6] å¯«å…¥åˆå§‹è³‡æ–™ (Admin, Team, Project)..."
# æ­¤æ™‚è³‡æ–™åº«å·²ä¿è­‰å­˜åœ¨ï¼Œè…³æœ¬ä¸€å®šæœƒæˆåŠŸ
sudo docker exec -e REPORT_HOST="$REPORT_HOST" $CONTAINER_NAME sh -c "cat /app/init_bugsink.py | python manage.py shell"

echo "ğŸ“¥ [6/6] åŒ¯å‡º DSN..."
sudo docker exec $CONTAINER_NAME cat dsn.txt > client_dsn.txt

# ä¿®æ­£ DSN Host
if [ -n "$REPORT_HOST" ]; then
    sed -i "s/example.com/$REPORT_HOST/g" client_dsn.txt
fi

DSN=$(cat client_dsn.txt)
echo ""
echo "ğŸ‰ è¨­å®šå®Œæˆï¼"
echo "---------------------------------------------------"
echo "DSN: $DSN"
echo "---------------------------------------------------"
echo "æ‚¨å¯ä»¥ç™»å…¥ç¶²é æª¢æŸ¥ï¼š http://localhost:$DOCKER_PORT"
